@startuml
'https://plantuml.com/state-diagram

scale 1000 width

[*] -right-> inAct

state "Inactive" as inAct
state "Active" as act {
    act: entry: WallboxMonitor.subscribeState(this)
    act: exit: WallboxMonitor.unsubscribeState(this)

     [*] -left-> noCar : [noCarConnected]

    state "NoCarConnected" as noCar
'      nocl: entry: cancelCharging()

    state "CarConnected" as carCon {

        state "ChargingStopped" as cStop
            cStop: entry: stopCharging()
            cStop: exit: forceDefaultIfStopped()

        state "ChargePvSurplus" as cSurplus {
          cSurplus: entry: PvChargeStrategy.startStrategy(this)
          cSurplus: entry: stopCharging()
          cSurplus: exit: PvChargeStrategy.stopStrategy(this)

            state "HasSurplus" as hasPlus {
                hasPlus: entry: setCurrent(v)
                hasPlus: entry: startCharging()
                hasPlus: on: surplus(v) : setCurrent(v)
                hasPlus: exit: stopCharging()
            }

            state "NoSurplus" as noPlus {
              noPlus: on: noSurplus : ignore
            }

        state lpstart <<start>>

      }

      state "ChargeTibber" as cTibber
      cTibber: entry: startTibberMonitor
      cTibber: exit: stopTibberMonitor
      cTibber: on: tibberGo : startCharging()
      cTibber: on: tibberHalt : stopCharging()


      state "ChargeAnyway" as cAnyway
        cAnyway: entry: startCharging()
        cAnyway: entry: setCurrent(maxCurrent)
        cAnyway: exit:stopCharging()

      state "switch" as choiceCmd <<choice>>

      note top of choiceCmd
        choice has semantic of switch/case,
        \tsee sequence of cases
      end note

      note "anyStop = FullyCharged || \n\tStoppedByCar||\n\tStoppedByApp||\n\tcmdChargeStop" as NcarCon

      [H] -left-> choiceCmd : chargeCmdChanged
      [*] --> choiceCmd
    }
     [*] --> carCon : [isCarConnected]
     cSurplus -down-> cStop : anyStop
     cTibber -down-> cStop : anyStop
     cAnyway -down-> cStop : anyStop
     carCon -up-> noCar : carDisconnected
'     noCar -down-> choiceCmd : carConnected

}


choiceCmd -left-> cSurplus : [4: cmdChargePvSurplus]
choiceCmd -down-> cTibber : [3: cmdChargeTibber]
choiceCmd --> cAnyway : [2: cmdChargeAnyway]
choiceCmd --> cStop : [1: anyStop]
cStop -up-> choiceCmd : extStartCmd

'carCon --> cStop : fullyCharged

noCar --> carCon : carConnected
inAct -down-> act : activate
act -up-> inAct : deactivate

noPlus -down-> hasPlus : surplus(v)
hasPlus -up-> noPlus : noSurplus
lpstart -right-> noPlus

note "CarChargingManager" as NTop

@enduml